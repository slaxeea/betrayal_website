<!DOCTYPE html>

<html>

<head>
    <title>btryl clothing</title>
    <link rel="stylesheet" href="../style/style.css" />
    <link rel="stylesheet" href="../style/navbtn.css" />
    <link rel="stylesheet" href="../style/dashboard.css" />
    <link rel="stylesheet" href="../style/form.css" />
    <link rel="shortcut icon" type="image/png" href="../imgs/favicon.ico" />
    <script src="https://code.jquery.com/jquery-3.6.0.js"
        integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@1.28.2/dist/umd/supabase.min.js"></script>

    <meta charset="utf-8" />
    <meta name="description" content="Betrayal by Michel Biondi" />
    <meta name="keywords" content="Betrayal" />
    <meta name="author" content="Michele Biondi & Simon Kappeler" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="../js/dropdown.js"></script>
    <script src="../js/auth.js"></script>
    <meta lang="en" />

</head>

<body>
    <div class="grid-container">

        <ul class="nav-bar">
            <li><a href="../index.html" class="nav-btn">home</a></li>
            <li><a href="../collection_2020.html" class="nav-btn">winter collection 2021</a></li>
            <li><a href="../collection_2021.html" class="nav-btn">summer start-up</a></li><br>

            <li><a href="../about.html" class="nav-btn" id="a">about</a></li><br>

            <li><a href="../tos.html" class="nav-btn less-padding" id="a">agb</a></li>
            <li><a href="../impressum.html" class="nav-btn less-padding" id="a">impressum</a></li><br>
            
            <li><p class="user" id="user"></p></li>
        </ul>

    </div>

    <div class="head">
        <img src="../imgs/BtrylMainLogo.png" class="mini-logo" alt="logo" onclick="dropdown()">
        <div class="cart-container">
            <p class="user" id="user"></p>
        </div>
        <ul class="mobile-nav-bar" id="mobile-nav-bar">
            <li><a href="../index.html" class="nav-btn">home</a></li>
            <li><a href="../collection_2020.html" class="nav-btn">winter collection 2021</a></li>
            <li><a href="../collection_2021.html" class="nav-btn">summer start-up</a></li><br>
            <li><a href="../about.html" class="nav-btn" id="a">about</a></li><br>

            <li><a href="../tos.html" class="nav-btn less-padding " id="a">agb</a></li>
            <li><a href="../impressum.html" class="nav-btn less-padding" id="a">impressum</a></li><br>
            
            <li><p class="user" id="user"></p></li>
        </ul>
    </div>

    <div class="main">
        <div id="ankor">
        </div>


    </div>

    <script>
        $(document).ready(function () {
            supabase = init();
            if (getCurrentUser()) {
                getOrders();
                $(".user").text("Logout")
            } else {
                $("#ankor").append("<h3>please login to see your dasboard</h3>");
                $(".user").text("Login")
            }
            supabase.auth.onAuthStateChange((event, session) => {
                if (event == "SIGNED_IN") {
                    getOrders();
                    $(".user").text("Logout")
                }
                else {
                    empty();
                    $("#ankor").append("<h3>please login to see your dasboard</h3>");
                    $(".user").text("Login")
                }
            })
            $(".user").click(function () {
                if (getCurrentUser()) {
                    logout();
                    empty();
                    $("#ankor").append("<h3>please login to see your dasboard</h3>");
                    $(".user").text("Login")
                } else {
                    localStorage.setItem("redirect", window.location.href);
                    window.location.href = "./login.html"
                }
            })
        });

        function getOrders() {
            empty();
            let { data: orders, error } = supabase
                .from('orders')
                .select('*')
                .eq("userid", supabase.auth.currentUser.id)
                .then(function (response) {
                    Array.from(response.data).forEach(function (val, key) {
                        let order = JSON.parse(val.orderjson);
                        $("#ankor").append(`
                            <div class="order" key="${key}">
                                <h3>Order ${key + 1}</h3>
                                <p>${getOrderFromJson(order)}</p>
                                <button class="delete-order-button" onclick="deleteOrder(${val.id})">Bestellung löschen</button>
                                <button class="modify-order-button" onclick="mofifyOrder(${val.id})">Bestellung ändern</button>
                            </div>
                        `);
                    })

                }).catch(function (error) {
                    console.error(error);
                });
        }

        function deleteOrder(id) {
            if (getCurrentUser()) {
                const { data, error } = supabase
                    .from('orders')
                    .delete()
                    .match({ id: id })
                    .then(function (res) {
                        console.log(res);
                    })
                setTimeout(200, getOrders());
            } else {
                alert("please login to delete orders");
            }

        }

        function mofifyOrder(id) {
            if (getCurrentUser()) {
                console.log(`mofiyied order ${id}`);
            } else {
                alert("please login to modify orders");
            }
        }
        function getOrderFromJson(order) {
            let orderarray = new Map();
            let orderstring = "";
            for (let i = 0; order[i] != null; i++) {
                orderarray.set(i, order[i]);
            }

            console.log(orderarray);

            orderarray.forEach(function (val, key) {
                orderstring += `
                    <div>
                        <p>Name: ${order[0].name}, Grösse: ${order[0].size}, Menge: ${order[0].quantity}</p>
                    </div>
                `;
            });
            return orderstring;
        }

        function empty() {
            $("#ankor").empty();
        }

        function toggle() {
            var rn = document.getElementById("hidden-text");
            var btn = document.getElementById("hidden-btn");
            if (rn.innerHTML == "Ja") {
                rn.innerHTML = "Nein"
                btn.setAttribute("href", "payment_noTwint.html");
            } else {
                rn.innerHTML = "Ja"
                btn.setAttribute("href", "payment.html");
            }
        }
    </script>

</body>

</html>